# 用户付款功能说明

## 功能概述
新增了完整的用户付款管理系统，允许管理员追踪和管理用户参与活动的付款记录。

## 用户端功能 (`/payments`)

### 查看付款记录
- 显示所有个人付款记录
- 按创建时间降序排列
- 显示活动名称、金额、状态、付款日期和备注

### 付款统计摘要
- **已付款总额**：显示所有已付款的总金额
- **待付款总额**：显示所有待付款的总金额
- **逾期总额**：显示所有逾期付款的总金额

### 付款状态
- 🟡 **待付款** (pending)
- 🟢 **已付款** (paid)
- 🔴 **逾期** (overdue)
- ⚫ **已取消** (cancelled)

## 管理员功能 (`/admin/payments`)

### 查看所有付款记录
- 显示所有用户的付款记录
- 查看用户信息（姓名、邮箱）
- 显示统计摘要（总金额、记录数量）

### 编辑付款记录
每条付款记录可以编辑：
1. **金额**：输入付款金额（TWD）
2. **状态**：从下拉选单选择状态
3. **付款日期**：选择实际付款日期（选填）
4. **活动**：从下拉选单关联活动
5. **备注**：添加额外说明（如转帐后五码）

### 删除付款记录
- 点击"刪除記錄"按钮
- 需要确认才能删除

## 数据库架构

### `user_payments` 表
```sql
- id: UUID (主键)
- user_id: UUID (外键 → auth.users)
- event_id: UUID (外键 → events)
- amount: DECIMAL(10, 2)
- status: TEXT (pending/paid/overdue/cancelled)
- payment_date: TIMESTAMPTZ (选填)
- notes: TEXT (选填)
- created_at: TIMESTAMPTZ
- updated_at: TIMESTAMPTZ
```

### RLS 策略
- ✅ 用户可以查看自己的付款记录
- ✅ 管理员可以查看、新增、更新、删除所有付款记录

## API 路由

### `PATCH /api/admin/payments/[id]`
更新付款记录（仅管理员）
```typescript
{
  amount: number,
  status: 'pending' | 'paid' | 'overdue' | 'cancelled',
  payment_date: string | null,
  event_id: string,
  notes: string
}
```

### `DELETE /api/admin/payments/[id]`
删除付款记录（仅管理员）

## 导航更新

### 主导航 (SiteHeader)
新增链接：**我的付款** → `/payments`

### 管理员侧边栏 (AdminSidebar)
新增链接：**付款管理** 💳 → `/admin/payments`

## 使用场景

### 场景 1: 用户查看自己的付款状态
1. 登入后点击导航栏"我的付款"
2. 查看所有参与活动的付款记录
3. 了解总计已付、待付和逾期金额

### 场景 2: 管理员添加付款记录
1. 前往管理员面板 → 付款管理
2. （未来可添加"新增付款"按钮）
3. 或在用户报名时自动创建付款记录

### 场景 3: 管理员更新付款状态
1. 用户回报已转账
2. 管理员在付款管理页面找到该记录
3. 更新状态为"已付款"
4. 填写付款日期和备注（如转帐后五码）

### 场景 4: 处理逾期付款
1. 管理员筛选逾期付款记录
2. 联系用户催缴
3. 收到款项后更新状态

## 未来增强建议

1. **新增付款记录**：添加"新增付款"按钮和表单
2. **批量操作**：批量更新多个付款记录的状态
3. **筛选和搜索**：按状态、活动、用户筛选
4. **导出功能**：导出付款记录为 CSV/Excel
5. **自动提醒**：逾期付款自动发送提醒通知
6. **付款凭证**：上传付款证明图片
7. **统计报表**：更详细的财务统计和图表
8. **整合报名**：用户报名时自动创建付款记录
