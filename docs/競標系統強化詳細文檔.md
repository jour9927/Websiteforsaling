# ç«¶æ¨™ç³»çµ±å¼·åŒ–è©³ç´°æŠ€è¡“æ–‡æª”

**Commit**: `13227ab4cb96c92f4a5154fdc77791ab684d668a`  
**ä½œè€…**: DingChao Liao  
**æ—¥æœŸ**: 2026-02-17 21:14:59 +0800  
**æäº¤è¨Šæ¯**: feat: ç«¶æ¨™ç³»çµ±å¼·åŒ– - Anti-Snipeå»¶é•·ã€ç†±åº¦æ¨™ç±¤ã€è¢«è¶…åƒ¹é€šçŸ¥

---

## ğŸ“‹ ç›®éŒ„

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [è©³ç´°ç¨‹å¼ç¢¼è®Šæ›´](#è©³ç´°ç¨‹å¼ç¢¼è®Šæ›´)
  - [1. è³‡æ–™åº«å±¤ (SQL Migrations)](#1-è³‡æ–™åº«å±¤-sql-migrations)
  - [2. å‰ç«¯çµ„ä»¶ (React/TypeScript)](#2-å‰ç«¯çµ„ä»¶-reacttypescript)
- [æª”æ¡ˆè®Šæ›´æ¸…å–®](#æª”æ¡ˆè®Šæ›´æ¸…å–®)
- [æ¸¬è©¦å»ºè­°](#æ¸¬è©¦å»ºè­°)

---

## æ¦‚è¿°

æ­¤æ¬¡æ›´æ–°é‡å°ç«¶æ¨™ç³»çµ±é€²è¡Œå…¨é¢å¼·åŒ–ï¼Œä¸»è¦è§£æ±ºå…¬å¹³æ€§ã€ä½¿ç”¨è€…é«”é©—å’Œå³æ™‚äº’å‹•ä¸‰å¤§é¢å‘çš„å•é¡Œã€‚

### æ ¸å¿ƒæ”¹é€²

1. **Anti-Snipe é˜²ç‹™æ“Šæ©Ÿåˆ¶** - æœ€å¾Œ 60 ç§’å‡ºåƒ¹è‡ªå‹•å»¶é•· 2 åˆ†é˜
2. **ç†±åº¦æ¨™ç±¤ç³»çµ±** - æ ¹æ“šå‡ºåƒ¹æ¬¡æ•¸é¡¯ç¤º ğŸ”¥ç†±é–€/æ¿€çƒˆ/ç™½ç†±åŒ–
3. **è¢«è¶…åƒ¹å³æ™‚é€šçŸ¥** - Realtime ç›£è½ï¼Œå½ˆå‡ºç´…è‰²è­¦å‘Š + å¿«é€ŸåŠ åƒ¹æŒ‰éˆ•
4. **å€’æ•¸è¨ˆæ™‚å™¨å¼·åŒ–** - æœ€å¾Œ 1 åˆ†é˜ç´…è‰²é–ƒçˆ + å»¶é•·æç¤º
5. **é–‹æ”¾å‡ºåƒ¹æ¬Šé™** - ç§»é™¤è§’è‰²é™åˆ¶ï¼Œæ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶çš†å¯å‡ºåƒ¹

### çµ±è¨ˆ

- **ä¿®æ”¹æª”æ¡ˆ**: 13 å€‹
- **æ–°å¢ä»£ç¢¼**: 425 è¡Œ
- **åˆªé™¤ä»£ç¢¼**: 38 è¡Œ
- **æ–°å¢ SQL Migration**: 2 å€‹

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. Anti-Snipe é˜²ç‹™æ“Šæ©Ÿåˆ¶ â°

**å•é¡Œ**: ç”¨æˆ¶åœ¨æœ€å¾Œä¸€ç§’å‡ºåƒ¹ï¼Œå…¶ä»–äººç„¡æ³•åæ‡‰  
**è§£æ±ºæ–¹æ¡ˆ**: æœ€å¾Œ 60 ç§’å…§å‡ºåƒ¹ï¼Œè‡ªå‹•å»¶é•· 2 åˆ†é˜

**å¯¦ä½œä½ç½®**: 
- `supabase/migrations/026_auction_enhancements.sql` (è³‡æ–™åº«å‡½æ•¸)
- `app/auctions/[id]/CountdownTimer.tsx` (å‰ç«¯é¡¯ç¤º)

**é‚è¼¯æµç¨‹**:
```
å‡ºåƒ¹æ™‚æª¢æŸ¥å‰©é¤˜æ™‚é–“
  â”œâ”€ å‰©é¤˜æ™‚é–“ < 60 ç§’
  â”‚   â”œâ”€ å»¶é•·çµæŸæ™‚é–“ + 2 åˆ†é˜
  â”‚   â”œâ”€ æ›´æ–°ç«¶æ¨™åƒ¹æ ¼å’Œå‡ºåƒ¹è€…
  â”‚   â””â”€ å›å‚³ { success: true, extended: true }
  â””â”€ å‰©é¤˜æ™‚é–“ >= 60 ç§’
      â”œâ”€ æ­£å¸¸æ›´æ–°åƒ¹æ ¼
      â””â”€ å›å‚³ { success: true, extended: false }
```

---

### 2. ç†±åº¦æ¨™ç±¤ç³»çµ± ğŸ”¥

**åŠŸèƒ½**: æ ¹æ“šå‡ºåƒ¹æ¬¡æ•¸å‹•æ…‹é¡¯ç¤ºç«¶çˆ­æ¿€çƒˆç¨‹åº¦

**åˆ†ç´šæ¨™æº–**:
- **ğŸ”¥ ç†±é–€**: 5-9 æ¬¡å‡ºåƒ¹ (é»ƒè‰²)
- **ğŸ”¥ğŸ”¥ æ¿€çƒˆ**: 10-19 æ¬¡å‡ºåƒ¹ (æ©™è‰²)
- **ğŸ”¥ğŸ”¥ğŸ”¥ ç™½ç†±åŒ–**: 20+ æ¬¡å‡ºåƒ¹ (ç´…è‰² + é–ƒçˆå‹•ç•«)

**é¡¯ç¤ºä½ç½®**:
- ç«¶æ¨™åˆ—è¡¨é  (`components/AuctionCard.tsx`)
- ç«¶æ¨™è©³æƒ…é  (`app/auctions/[id]/page.tsx`)

---

### 3. è¢«è¶…åƒ¹å³æ™‚é€šçŸ¥ âš ï¸

**åŠŸèƒ½**: ç•¶ä½¿ç”¨è€…æ˜¯æœ€é«˜å‡ºåƒ¹è€…ä½†è¢«è¶…åƒ¹æ™‚ï¼Œç«‹å³æ”¶åˆ°é€šçŸ¥

**æŠ€è¡“å¯¦ä½œ**:
- ä½¿ç”¨ **Supabase Realtime** è¨‚é–± `auctions` è¡¨æ›´æ–°
- è¿½è¹¤ä½¿ç”¨è€…æ˜¯å¦ç‚ºç•¶å‰æœ€é«˜å‡ºåƒ¹è€…
- è¢«è¶…åƒ¹æ™‚å½ˆå‡ºç´…è‰²è­¦å‘Šå‹•ç•«
- 10 ç§’å¾Œè‡ªå‹•éš±è—

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  ä½ å·²è¢«è¶…åƒ¹ï¼                     â”‚
â”‚    {è¶…åƒ¹è€…åç¨±} å‡ºåƒ¹ ${æ–°åƒ¹æ ¼}       â”‚
â”‚                        [ç«‹å³åŠ åƒ¹]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. å€’æ•¸è¨ˆæ™‚å™¨å¼·åŒ– ğŸš¨

**æ–°å¢åŠŸèƒ½**:
- æœ€å¾Œ 60 ç§’æ–‡å­—è®Šç‚ºç´…è‰² + é–ƒçˆå‹•ç•«
- é¡¯ç¤ºã€Œâš¡ å³å°‡çµæŸï¼ã€æç¤º
- åµæ¸¬å»¶é•·äº‹ä»¶ï¼Œé¡¯ç¤ºã€Œâ° æœ‰äººå‡ºåƒ¹ï¼è¨ˆæ™‚å»¶é•· 2 åˆ†é˜ã€
- æç¤ºã€Œæœ€å¾Œä¸€åˆ†é˜å‡ºåƒ¹å°‡å»¶é•·æ™‚é–“ã€

---

### 5. é–‹æ”¾å‡ºåƒ¹æ¬Šé™ ğŸ‘¥

**è®Šæ›´å‰**: åªæœ‰ `member` æˆ– `admin` è§’è‰²å¯å‡ºåƒ¹  
**è®Šæ›´å¾Œ**: æ‰€æœ‰**å·²ç™»å…¥ç”¨æˆ¶** (`authenticated`) çš†å¯å‡ºåƒ¹

**åŸå› **: é™ä½åƒèˆ‡é–€æª»ï¼Œæå‡ç«¶æ¨™æ´»èºåº¦

---

## è©³ç´°ç¨‹å¼ç¢¼è®Šæ›´

### 1. è³‡æ–™åº«å±¤ (SQL Migrations)

#### ğŸ“„ `supabase/migrations/025_open_bidding_all_users.sql`

**æ–°å¢æª”æ¡ˆ** - é–‹æ”¾å‡ºåƒ¹æ¬Šé™

```sql
-- æ˜¥ç¯€é™æ™‚ç«¶æ¨™ï¼šé–‹æ”¾æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶å‡ºåƒ¹
-- åŸæœ¬é™åˆ¶ member/admin æ‰èƒ½å‡ºåƒ¹ï¼Œç¾æ”¹ç‚ºæ‰€æœ‰ authenticated ç”¨æˆ¶

-- ============================================
-- 1. ä¿®æ”¹ bids INSERT RLS æ”¿ç­–
-- ============================================
DROP POLICY IF EXISTS "bids_insert_member" ON bids;

CREATE POLICY "bids_insert_authenticated" ON bids
    FOR INSERT
    WITH CHECK (auth.uid() IS NOT NULL);

-- ============================================
-- 2. ä¿®æ”¹ place_bid å‡½æ•¸ï¼šç§»é™¤è§’è‰²æª¢æŸ¥
-- ============================================
CREATE OR REPLACE FUNCTION place_bid(
    p_auction_id UUID,
    p_user_id UUID,
    p_amount INTEGER
)
RETURNS JSON AS $$
DECLARE
    v_auction auctions%ROWTYPE;
    v_new_bid bids%ROWTYPE;
BEGIN
    -- æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥ï¼ˆä¸å†é™åˆ¶è§’è‰²ï¼‰
    IF p_user_id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'è«‹å…ˆç™»å…¥');
    END IF;

    -- å–å¾—ç«¶æ¨™è³‡è¨Šä¸¦é–å®š
    SELECT * INTO v_auction FROM auctions WHERE id = p_auction_id FOR UPDATE;

    IF v_auction IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'æ‰¾ä¸åˆ°æ­¤ç«¶æ¨™');
    END IF;

    -- æª¢æŸ¥ç«¶æ¨™ç‹€æ…‹
    IF v_auction.status != 'active' THEN
        RETURN json_build_object('success', false, 'error', 'æ­¤ç«¶æ¨™å°šæœªé–‹å§‹æˆ–å·²çµæŸ');
    END IF;

    -- æª¢æŸ¥æ˜¯å¦å·²éæœŸ
    IF v_auction.end_time < NOW() THEN
        UPDATE auctions SET status = 'ended' WHERE id = p_auction_id;
        RETURN json_build_object('success', false, 'error', 'ç«¶æ¨™å·²çµæŸ');
    END IF;

    -- æª¢æŸ¥å‡ºåƒ¹é‡‘é¡
    IF v_auction.current_price = 0 THEN
        IF p_amount < v_auction.starting_price THEN
            RETURN json_build_object('success', false, 'error', 'å‡ºåƒ¹éœ€ >= èµ·æ¨™åƒ¹ ' || v_auction.starting_price);
        END IF;
    ELSE
        IF p_amount < v_auction.current_price + v_auction.min_increment THEN
            RETURN json_build_object('success', false, 'error', 'å‡ºåƒ¹éœ€ >= ' || (v_auction.current_price + v_auction.min_increment));
        END IF;
    END IF;

    -- æ–°å¢å‡ºåƒ¹ç´€éŒ„
    INSERT INTO bids (auction_id, user_id, amount)
    VALUES (p_auction_id, p_user_id, p_amount)
    RETURNING * INTO v_new_bid;

    -- æ›´æ–°ç«¶æ¨™è³‡è¨Š
    UPDATE auctions
    SET current_price = p_amount,
        current_bidder_id = p_user_id,
        bid_count = bid_count + 1
    WHERE id = p_auction_id;

    RETURN json_build_object(
        'success', true,
        'bid_id', v_new_bid.id,
        'amount', p_amount
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**é—œéµè®Šæ›´**:
- ç§»é™¤ `bids_insert_member` æ”¿ç­–
- æ–°å¢ `bids_insert_authenticated` æ”¿ç­– (åªæª¢æŸ¥ `auth.uid()`)
- `place_bid` å‡½æ•¸ç§»é™¤è§’è‰²æª¢æŸ¥é‚è¼¯

---

#### ğŸ“„ `supabase/migrations/026_auction_enhancements.sql`

**æ–°å¢æª”æ¡ˆ** - Anti-Snipe å»¶é•·æ©Ÿåˆ¶

```sql
-- ç«¶æ¨™ç³»çµ±å¼·åŒ–ï¼šAnti-Snipe å»¶é•· + é–‹æ”¾å‡ºåƒ¹æ¬Šé™
-- 1. ä¿®æ”¹ bids RLSï¼šå…è¨±æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶å‡ºåƒ¹
-- 2. ä¿®æ”¹ place_bidï¼šç§»é™¤è§’è‰²æª¢æŸ¥ + Anti-Snipe å»¶é•·

-- ============================================
-- 1. ä¿®æ”¹ bids INSERT RLS æ”¿ç­–
-- ============================================
DROP POLICY IF EXISTS "bids_insert_member" ON bids;
DROP POLICY IF EXISTS "bids_insert_authenticated" ON bids;

CREATE POLICY "bids_insert_authenticated" ON bids
    FOR INSERT
    WITH CHECK (auth.uid() IS NOT NULL);

-- ============================================
-- 2. ä¿®æ”¹ place_bid å‡½æ•¸
--    - ç§»é™¤ member è§’è‰²é™åˆ¶
--    - åŠ å…¥ Anti-Snipeï¼šæœ€å¾Œ 60 ç§’å‡ºåƒ¹å»¶é•· 2 åˆ†é˜
-- ============================================
CREATE OR REPLACE FUNCTION place_bid(
    p_auction_id UUID,
    p_user_id UUID,
    p_amount INTEGER
)
RETURNS JSON AS $$
DECLARE
    v_auction auctions%ROWTYPE;
    v_new_bid bids%ROWTYPE;
    v_time_remaining INTERVAL;
    v_extended BOOLEAN := false;
BEGIN
    -- æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥ï¼ˆä¸é™åˆ¶è§’è‰²ï¼‰
    IF p_user_id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'è«‹å…ˆç™»å…¥');
    END IF;

    -- å–å¾—ç«¶æ¨™è³‡è¨Šä¸¦é–å®š
    SELECT * INTO v_auction FROM auctions WHERE id = p_auction_id FOR UPDATE;

    IF v_auction IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'æ‰¾ä¸åˆ°æ­¤ç«¶æ¨™');
    END IF;

    -- æª¢æŸ¥ç«¶æ¨™ç‹€æ…‹
    IF v_auction.status != 'active' THEN
        RETURN json_build_object('success', false, 'error', 'æ­¤ç«¶æ¨™å°šæœªé–‹å§‹æˆ–å·²çµæŸ');
    END IF;

    -- æª¢æŸ¥æ˜¯å¦å·²éæœŸ
    IF v_auction.end_time < NOW() THEN
        UPDATE auctions SET status = 'ended' WHERE id = p_auction_id;
        RETURN json_build_object('success', false, 'error', 'ç«¶æ¨™å·²çµæŸ');
    END IF;

    -- æª¢æŸ¥å‡ºåƒ¹é‡‘é¡
    IF v_auction.current_price = 0 THEN
        IF p_amount < v_auction.starting_price THEN
            RETURN json_build_object('success', false, 'error', 'å‡ºåƒ¹éœ€ >= èµ·æ¨™åƒ¹ ' || v_auction.starting_price);
        END IF;
    ELSE
        IF p_amount < v_auction.current_price + v_auction.min_increment THEN
            RETURN json_build_object('success', false, 'error', 'å‡ºåƒ¹éœ€ >= ' || (v_auction.current_price + v_auction.min_increment));
        END IF;
    END IF;

    -- æ–°å¢å‡ºåƒ¹ç´€éŒ„
    INSERT INTO bids (auction_id, user_id, amount)
    VALUES (p_auction_id, p_user_id, p_amount)
    RETURNING * INTO v_new_bid;

    -- Anti-Snipeï¼šæœ€å¾Œ 60 ç§’å‡ºåƒ¹è‡ªå‹•å»¶é•· 2 åˆ†é˜
    v_time_remaining := v_auction.end_time - NOW();
    IF v_time_remaining < INTERVAL '60 seconds' THEN
        UPDATE auctions
        SET end_time = end_time + INTERVAL '2 minutes',
            current_price = p_amount,
            current_bidder_id = p_user_id,
            bid_count = bid_count + 1
        WHERE id = p_auction_id;
        v_extended = true;
    ELSE
        -- ä¸€èˆ¬æ›´æ–°
        UPDATE auctions
        SET current_price = p_amount,
            current_bidder_id = p_user_id,
            bid_count = bid_count + 1
        WHERE id = p_auction_id;
    END IF;

    RETURN json_build_object(
        'success', true,
        'bid_id', v_new_bid.id,
        'amount', p_amount,
        'extended', v_extended
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**é—œéµè®Šæ›´**:
- æ–°å¢ `v_time_remaining` å’Œ `v_extended` è®Šæ•¸
- è¨ˆç®—å‰©é¤˜æ™‚é–“ï¼š`v_time_remaining := v_auction.end_time - NOW()`
- æ¢ä»¶åˆ¤æ–·ï¼š`IF v_time_remaining < INTERVAL '60 seconds'`
- å»¶é•·æ™‚é–“ï¼š`end_time = end_time + INTERVAL '2 minutes'`
- å›å‚³å»¶é•·ç‹€æ…‹ï¼š`'extended', v_extended`

---

### 2. å‰ç«¯çµ„ä»¶ (React/TypeScript)

#### ğŸ“„ `app/auctions/[id]/BidOutbidAlert.tsx`

**æ–°å¢æª”æ¡ˆ** (135 è¡Œ) - è¢«è¶…åƒ¹å³æ™‚é€šçŸ¥çµ„ä»¶

```typescript
"use client";

import { useState, useEffect } from "react";
import { supabase } from "@/lib/supabase";

interface BidOutbidAlertProps {
    auctionId: string;
    isActive: boolean;
}

export default function BidOutbidAlert({ auctionId, isActive }: BidOutbidAlertProps) {
    const [outbid, setOutbid] = useState(false);
    const [newPrice, setNewPrice] = useState(0);
    const [newBidderName, setNewBidderName] = useState("");
    const [myUserId, setMyUserId] = useState<string | null>(null);
    const [wasBidder, setWasBidder] = useState(false);

    // å–å¾—ç›®å‰ä½¿ç”¨è€… ID
    useEffect(() => {
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (user) setMyUserId(user.id);
        });
    }, []);

    // è¨‚é–± auction çš„å³æ™‚æ›´æ–°
    useEffect(() => {
        if (!isActive || !myUserId) return;

        const channel = supabase
            .channel(`auction-outbid-${auctionId}`)
            .on(
                'postgres_changes',
                {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'auctions',
                    filter: `id=eq.${auctionId}`,
                },
                async (payload) => {
                    const updated = payload.new as {
                        current_price: number;
                        current_bidder_id: string;
                        end_time: string;
                    };

                    // å¦‚æœæˆ‘ä¹‹å‰æ˜¯æœ€é«˜å‡ºåƒ¹è€…ï¼Œä½†ç¾åœ¨ä¸æ˜¯äº† â†’ è¢«è¶…åƒ¹
                    if (wasBidder && updated.current_bidder_id !== myUserId) {
                        setNewPrice(updated.current_price);

                        // å–å¾—æ–°å‡ºåƒ¹è€…åç¨±
                        const { data: profile } = await supabase
                            .from('profiles')
                            .select('full_name, email')
                            .eq('id', updated.current_bidder_id)
                            .single();

                        setNewBidderName(
                            profile?.full_name || profile?.email?.split('@')[0] || 'å…¶ä»–äºº'
                        );
                        setOutbid(true);

                        // 10 ç§’å¾Œè‡ªå‹•éš±è—
                        setTimeout(() => setOutbid(false), 10000);
                    }

                    // è¿½è¹¤æˆ‘æ˜¯å¦ç‚ºç›®å‰æœ€é«˜å‡ºåƒ¹è€…
                    if (updated.current_bidder_id === myUserId) {
                        setWasBidder(true);
                    }
                }
            )
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, [auctionId, isActive, myUserId, wasBidder]);

    // é¦–æ¬¡è¼‰å…¥æ™‚æª¢æŸ¥è‡ªå·±æ˜¯å¦å·²ç¶“æ˜¯æœ€é«˜å‡ºåƒ¹è€…
    useEffect(() => {
        if (!myUserId || !isActive) return;

        supabase
            .from('auctions')
            .select('current_bidder_id')
            .eq('id', auctionId)
            .single()
            .then(({ data }) => {
                if (data?.current_bidder_id === myUserId) {
                    setWasBidder(true);
                }
            });
    }, [auctionId, myUserId, isActive]);

    // å‡ºåƒ¹æˆåŠŸå¾Œä¹Ÿæ¨™è¨˜ wasBidder
    useEffect(() => {
        const handleBidSuccess = () => setWasBidder(true);
        window.addEventListener('bid-success', handleBidSuccess);
        return () => window.removeEventListener('bid-success', handleBidSuccess);
    }, []);

    if (!outbid) return null;

    const scrollToBid = () => {
        document.querySelector('[data-bid-input]')?.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
        setOutbid(false);
    };

    return (
        <div className="fixed top-20 left-1/2 z-50 -translate-x-1/2 w-[90%] max-w-md animate-bounce">
            <div className="rounded-2xl border border-red-500/50 bg-gradient-to-r from-red-900/95 to-orange-900/95 p-4 shadow-2xl shadow-red-500/20 backdrop-blur-md">
                <div className="flex items-center gap-3">
                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-red-500/30 text-xl">
                        âš ï¸
                    </div>
                    <div className="flex-1">
                        <p className="text-sm font-bold text-red-200">ä½ å·²è¢«è¶…åƒ¹ï¼</p>
                        <p className="text-xs text-red-300/70">
                            {newBidderName} å‡ºåƒ¹ <span className="font-bold text-yellow-300">${newPrice.toLocaleString()}</span>
                        </p>
                    </div>
                    <button
                        onClick={scrollToBid}
                        className="rounded-xl bg-red-500 px-4 py-2 text-sm font-bold text-white transition hover:bg-red-400"
                    >
                        ç«‹å³åŠ åƒ¹
                    </button>
                </div>
            </div>
        </div>
    );
}
```

**æ ¸å¿ƒé‚è¼¯**:
1. **è¿½è¹¤ç‹€æ…‹**: `wasBidder` è¨˜éŒ„ä½¿ç”¨è€…æ˜¯å¦æ›¾æ˜¯æœ€é«˜å‡ºåƒ¹è€…
2. **Realtime è¨‚é–±**: ç›£è½ `auctions` è¡¨çš„ `UPDATE` äº‹ä»¶
3. **è¢«è¶…åƒ¹æª¢æ¸¬**: `wasBidder && updated.current_bidder_id !== myUserId`
4. **å–å¾—è¶…åƒ¹è€…è³‡è¨Š**: å¾ `profiles` è¡¨æŸ¥è©¢åç¨±
5. **è‡ªå‹•éš±è—**: 10 ç§’å¾Œé—œé–‰é€šçŸ¥
6. **å¿«é€ŸåŠ åƒ¹**: é»æ“ŠæŒ‰éˆ•æ»¾å‹•åˆ°å‡ºåƒ¹è¼¸å…¥æ¡†

---

#### ğŸ“„ `app/auctions/[id]/CountdownTimer.tsx`

**ä¿®æ”¹å…§å®¹** - å€’æ•¸è¨ˆæ™‚å™¨å¼·åŒ–

```diff
export default function CountdownTimer({ endTime, isEnded }: CountdownTimerProps) {
    const [remainingTime, setRemainingTime] = useState("");
    const [isExpired, setIsExpired] = useState(isEnded);
+    const [isUrgent, setIsUrgent] = useState(false);
+    const [wasExtended, setWasExtended] = useState(false);
+    const [prevEndTime, setPrevEndTime] = useState(endTime);
+
+    // åµæ¸¬ endTime è¢«å»¶é•·
+    useEffect(() => {
+        if (endTime !== prevEndTime && !isEnded) {
+            setWasExtended(true);
+            setPrevEndTime(endTime);
+            // 3 ç§’å¾Œéš±è—å»¶é•·æç¤º
+            const timeout = setTimeout(() => setWasExtended(false), 5000);
+            return () => clearTimeout(timeout);
+        }
+    }, [endTime, prevEndTime, isEnded]);

    useEffect(() => {
        if (isEnded) {
            setRemainingTime("å·²çµæŸ");
            setIsExpired(true);
+            setIsUrgent(false);
            return;
        }

        const updateTime = () => {
            const now = new Date();
            const end = new Date(endTime);
            const diff = end.getTime() - now.getTime();

            if (diff <= 0) {
                setRemainingTime("å·²çµæŸ");
                setIsExpired(true);
+                setIsUrgent(false);
                return;
            }

+            // æœ€å¾Œ 60 ç§’é€²å…¥ç·Šæ€¥æ¨¡å¼
+            setIsUrgent(diff <= 60000);
+
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (days > 0) {
                setRemainingTime(`${days}å¤© ${hours}å°æ™‚ ${minutes}åˆ†`);
            } else if (hours > 0) {
                setRemainingTime(`${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
            } else {
                setRemainingTime(`${minutes}:${seconds.toString().padStart(2, '0')}`);
            }
        };

        updateTime();
        const interval = setInterval(updateTime, 1000);
        return () => clearInterval(interval);
    }, [endTime, isEnded]);

    return (
-        <div className={`text-center ${isExpired ? 'text-gray-400' : 'text-yellow-400'}`}>
+        <div className={`text-center ${isExpired ? 'text-gray-400' : isUrgent ? 'text-red-400' : 'text-yellow-400'}`}>
            <div className="text-xs text-white/60 mb-1">
-                {isExpired ? 'å·²çµæ¨™' : 'çµæŸå€’æ•¸'}
+                {isExpired ? 'å·²çµæ¨™' : isUrgent ? 'âš¡ å³å°‡çµæŸï¼' : 'çµæŸå€’æ•¸'}
            </div>
-            <div className={`text-2xl font-bold font-mono ${!isExpired && 'animate-pulse'}`}>
+            <div className={`text-2xl font-bold font-mono ${isExpired ? '' : isUrgent ? 'animate-pulse text-red-400' : 'animate-pulse'
+                }`}>
                {remainingTime || 'è¨ˆç®—ä¸­...'}
            </div>
+            {wasExtended && (
+                <div className="mt-2 animate-bounce rounded-full bg-orange-500/20 px-3 py-1 text-xs font-medium text-orange-300">
+                    â° æœ‰äººå‡ºåƒ¹ï¼è¨ˆæ™‚å»¶é•· 2 åˆ†é˜
+                </div>
+            )}
+            {isUrgent && !isExpired && !wasExtended && (
+                <div className="mt-2 text-xs text-red-300/70">
+                    æœ€å¾Œä¸€åˆ†é˜å‡ºåƒ¹å°‡å»¶é•·æ™‚é–“
+                </div>
+            )}
        </div>
    );
}
```

**é—œéµæ–°å¢**:
- `isUrgent`: å‰©é¤˜æ™‚é–“ <= 60 ç§’
- `wasExtended`: åµæ¸¬ `endTime` è®ŠåŒ–ï¼ˆAnti-Snipe è§¸ç™¼ï¼‰
- ç·Šæ€¥ç‹€æ…‹è¦–è¦ºï¼šç´…è‰²æ–‡å­— + é–ƒçˆ
- å»¶é•·æç¤ºï¼šã€Œâ° æœ‰äººå‡ºåƒ¹ï¼è¨ˆæ™‚å»¶é•· 2 åˆ†é˜ã€
- è­¦å‘Šè¨Šæ¯ï¼šã€Œæœ€å¾Œä¸€åˆ†é˜å‡ºåƒ¹å°‡å»¶é•·æ™‚é–“ã€

---

#### ğŸ“„ `app/auctions/[id]/BidButton.tsx`

**ä¿®æ”¹å…§å®¹** - å‡ºåƒ¹æˆåŠŸäº‹ä»¶é€šçŸ¥

```diff
            setSuccess("å‡ºåƒ¹æˆåŠŸï¼");
+            // é€šçŸ¥ BidOutbidAlert è¿½è¹¤å‡ºåƒ¹ç‹€æ…‹
+            window.dispatchEvent(new CustomEvent('bid-success'));
            router.refresh();

            // æ›´æ–°ç‚ºä¸‹ä¸€å€‹æœ€ä½å‡ºåƒ¹é‡‘é¡
```

```diff
                    <input
                        type="number"
                        min={minBid}
                        value={bidAmount}
                        onChange={(e) => setBidAmount(parseInt(e.target.value) || minBid)}
+                        data-bid-input
                        className="w-full rounded-xl border border-white/20 bg-white/10 py-3 pl-8 pr-4 text-lg font-semibold text-white text-center focus:border-white/40 focus:outline-none"
                    />
```

**é—œéµè®Šæ›´**:
- å‡ºåƒ¹æˆåŠŸå¾Œè§¸ç™¼ `bid-success` äº‹ä»¶ï¼Œé€šçŸ¥ `BidOutbidAlert` çµ„ä»¶
- æ–°å¢ `data-bid-input` å±¬æ€§ï¼Œä¾›ã€Œç«‹å³åŠ åƒ¹ã€æŒ‰éˆ•å®šä½æ»¾å‹•

---

#### ğŸ“„ `app/auctions/[id]/AuctionPageClient.tsx`

**ä¿®æ”¹å…§å®¹** - æ•´åˆè¢«è¶…åƒ¹é€šçŸ¥çµ„ä»¶

```diff
import { AuctionSidebarActivity } from "./AuctionActivityWrapper";
import { SimulatedViewers, SimulatedViewerJoinToast } from "@/components/SimulatedActivity";
import BidButton from "./BidButton";
+import BidOutbidAlert from "./BidOutbidAlert";
```

```diff
            {/* æµ®å‹•åœ¨ç·šäººæ•¸ï¼ˆä½¿ç”¨çµ±ä¸€çš„ ViewerContextï¼‰ */}
            {isActiveState && <FloatingViewerCount />}

+            {/* è¢«è¶…åƒ¹å³æ™‚é€šçŸ¥ */}
+            {isActiveState && <BidOutbidAlert auctionId={auctionId} isActive={isActiveState} />}
+
            {/* å³æ™‚å‡ºåƒ¹ Toast é€šçŸ¥ */}
            {isActiveState && <SimulatedViewerJoinToast />}
```

**é—œéµè®Šæ›´**:
- å¼•å…¥ `BidOutbidAlert` çµ„ä»¶
- åƒ…åœ¨ç«¶æ¨™é€²è¡Œä¸­ (`isActiveState`) æ™‚é¡¯ç¤º

---

#### ğŸ“„ `app/auctions/[id]/page.tsx`

**ä¿®æ”¹å…§å®¹** - è©³æƒ…é ç†±åº¦æ¨™ç±¤

```diff
                        {auction.bid_count >= 20 ? (
                            <span className="rounded-full bg-red-500/90 px-3 py-1 text-xs font-bold text-white animate-pulse">
                                ğŸ”¥ğŸ”¥ğŸ”¥ ç™½ç†±åŒ–
                            </span>
                        ) : auction.bid_count >= 10 ? (
                            <span className="rounded-full bg-orange-500/80 px-3 py-1 text-xs font-bold text-white">
                                ğŸ”¥ğŸ”¥ æ¿€çƒˆ
                            </span>
                        ) : auction.bid_count >= 5 ? (
                            <span className="rounded-full bg-yellow-600/80 px-3 py-1 text-xs font-medium text-white">
                                ğŸ”¥ ç†±é–€
                            </span>
                        ) : null}
```

**é—œéµè®Šæ›´**:
- åœ¨è©³æƒ…é é ‚éƒ¨é¡¯ç¤ºç†±åº¦æ¨™ç±¤
- ä½¿ç”¨ `auction.bid_count` åˆ¤æ–·ç­‰ç´š

---

#### ğŸ“„ `components/AuctionCard.tsx`

**ä¿®æ”¹å…§å®¹** - åˆ—è¡¨é ç†±åº¦æ¨™ç±¤

```diff
                {/* ç‹€æ…‹æ¨™ç±¤ */}
-                <div className="absolute top-3 right-3">
+                <div className="absolute top-3 right-3 flex flex-col items-end gap-1">
                    {isEnded ? (
                        <span className="rounded-full bg-gray-900/80 px-3 py-1 text-xs font-medium text-gray-300">
                            å·²çµæ¨™
                        </span>
                    ) : (
                        <span className="rounded-full bg-green-500/80 px-3 py-1 text-xs font-medium text-white animate-pulse">
                            ğŸ”´ ç«¶æ¨™ä¸­
                        </span>
                    )}
+                    {estimatedBidCount >= 20 ? (
+                        <span className="rounded-full bg-red-500/90 px-2 py-0.5 text-xs font-bold text-white animate-pulse">
+                            ğŸ”¥ğŸ”¥ğŸ”¥ ç™½ç†±åŒ–
+                        </span>
+                    ) : estimatedBidCount >= 10 ? (
+                        <span className="rounded-full bg-orange-500/80 px-2 py-0.5 text-xs font-bold text-white">
+                            ğŸ”¥ğŸ”¥ æ¿€çƒˆ
+                        </span>
+                    ) : estimatedBidCount >= 5 ? (
+                        <span className="rounded-full bg-yellow-600/80 px-2 py-0.5 text-xs font-medium text-white">
+                            ğŸ”¥ ç†±é–€
+                        </span>
+                    ) : null}
                </div>
```

**é—œéµè®Šæ›´**:
- èª¿æ•´ä½ˆå±€ç‚º `flex flex-col` æ”¯æ´å¤šå€‹æ¨™ç±¤
- ä½¿ç”¨ `estimatedBidCount` (ä¼°ç®—å‡ºåƒ¹æ•¸) åˆ¤æ–·ç†±åº¦

---

### å…¶ä»–ä¿®æ”¹æª”æ¡ˆ

ä»¥ä¸‹æª”æ¡ˆçš„è®Šæ›´èˆ‡åœ–é‘‘æ›¸ç±¤è³‡æ–™æ›´æ–°ç›¸é—œï¼Œéæ ¸å¿ƒç«¶æ¨™åŠŸèƒ½ï¼š

- `components/BookGuideCard.tsx`
- `components/BookGuideDetail.tsx`
- `components/GuidesContent.tsx`
- `docs/é…å¸ƒé»æ•¸è¨ˆç®—ç³»çµ±.md`
- `lib/guideBooksData.ts`

---

## æª”æ¡ˆè®Šæ›´æ¸…å–®

| æª”æ¡ˆè·¯å¾‘ | è®Šæ›´é¡å‹ | è¡Œæ•¸è®ŠåŒ– | èªªæ˜ |
|---------|---------|---------|------|
| `app/auctions/[id]/AuctionPageClient.tsx` | ä¿®æ”¹ (M) | +4 | æ•´åˆè¢«è¶…åƒ¹é€šçŸ¥çµ„ä»¶ |
| `app/auctions/[id]/BidButton.tsx` | ä¿®æ”¹ (M) | +3 | æ–°å¢å‡ºåƒ¹æˆåŠŸäº‹ä»¶ + data-bid-input |
| `app/auctions/[id]/BidOutbidAlert.tsx` | **æ–°å¢ (A)** | **+135** | **è¢«è¶…åƒ¹å³æ™‚é€šçŸ¥çµ„ä»¶** |
| `app/auctions/[id]/CountdownTimer.tsx` | ä¿®æ”¹ (M) | +35 | ç·Šæ€¥ç‹€æ…‹ + å»¶é•·æç¤º |
| `app/auctions/[id]/page.tsx` | ä¿®æ”¹ (M) | +13 | è©³æƒ…é ç†±åº¦æ¨™ç±¤ |
| `components/AuctionCard.tsx` | ä¿®æ”¹ (M) | +15 | åˆ—è¡¨é ç†±åº¦æ¨™ç±¤ |
| `components/BookGuideCard.tsx` | ä¿®æ”¹ (M) | +4 | åœ–é‘‘æ›¸ç±¤æ›´æ–° |
| `components/BookGuideDetail.tsx` | ä¿®æ”¹ (M) | +4 | åœ–é‘‘æ›¸ç±¤æ›´æ–° |
| `components/GuidesContent.tsx` | ä¿®æ”¹ (M) | +2 | åœ–é‘‘æ›¸ç±¤æ›´æ–° |
| `docs/é…å¸ƒé»æ•¸è¨ˆç®—ç³»çµ±.md` | ä¿®æ”¹ (M) | +9 | æ–‡æª”æ›´æ–° |
| `lib/guideBooksData.ts` | ä¿®æ”¹ (M) | +64, -38 | åœ–é‘‘è³‡æ–™æ›´æ–° |
| `supabase/migrations/025_open_bidding_all_users.sql` | **æ–°å¢ (A)** | **+78** | **é–‹æ”¾å‡ºåƒ¹æ¬Šé™** |
| `supabase/migrations/026_auction_enhancements.sql` | **æ–°å¢ (A)** | **+97** | **Anti-Snipe å»¶é•·æ©Ÿåˆ¶** |

**ç¸½è¨ˆ**: 13 å€‹æª”æ¡ˆï¼Œ425+ è¡Œæ–°å¢ï¼Œ38- è¡Œåˆªé™¤

---

## æ¸¬è©¦å»ºè­°

### 1. Anti-Snipe æ©Ÿåˆ¶æ¸¬è©¦

**æ­¥é©Ÿ**:
1. å‰µå»ºä¸€å€‹å³å°‡çµæŸçš„æ¸¬è©¦ç«¶æ¨™ï¼ˆçµæŸæ™‚é–“ < 2 åˆ†é˜ï¼‰
2. åœ¨æœ€å¾Œ 60 ç§’å…§å‡ºåƒ¹
3. é©—è­‰çµæŸæ™‚é–“æ˜¯å¦å»¶é•· 2 åˆ†é˜
4. ç¢ºèª `CountdownTimer` é¡¯ç¤ºå»¶é•·æç¤º

**é æœŸçµæœ**:
- è³‡æ–™åº« `end_time` å¢åŠ  120 ç§’
- å‰ç«¯é¡¯ç¤ºã€Œâ° æœ‰äººå‡ºåƒ¹ï¼è¨ˆæ™‚å»¶é•· 2 åˆ†é˜ã€

---

### 2. ç†±åº¦æ¨™ç±¤æ¸¬è©¦

**æ­¥é©Ÿ**:
1. å‰µå»ºä¸åŒå‡ºåƒ¹æ¬¡æ•¸çš„ç«¶æ¨™ï¼š
   - 3 æ¬¡å‡ºåƒ¹ â†’ ç„¡æ¨™ç±¤
   - 7 æ¬¡å‡ºåƒ¹ â†’ ğŸ”¥ ç†±é–€
   - 15 æ¬¡å‡ºåƒ¹ â†’ ğŸ”¥ğŸ”¥ æ¿€çƒˆ
   - 25 æ¬¡å‡ºåƒ¹ â†’ ğŸ”¥ğŸ”¥ğŸ”¥ ç™½ç†±åŒ–
2. æª¢æŸ¥åˆ—è¡¨é å’Œè©³æƒ…é é¡¯ç¤º

**é æœŸçµæœ**:
- æ¨™ç±¤æ­£ç¢ºé¡¯ç¤ºå°æ‡‰ç†±åº¦ç­‰ç´š
- ç™½ç†±åŒ–æ¨™ç±¤æœ‰é–ƒçˆå‹•ç•«

---

### 3. è¢«è¶…åƒ¹é€šçŸ¥æ¸¬è©¦

**æ­¥é©Ÿ**:
1. ä½¿ç”¨å¸³è™Ÿ A ç™»å…¥ä¸¦å‡ºåƒ¹æˆç‚ºæœ€é«˜å‡ºåƒ¹è€…
2. ä½¿ç”¨å¸³è™Ÿ B ç™»å…¥ä¸¦å‡ºæ›´é«˜åƒ¹æ ¼
3. æª¢æŸ¥å¸³è™Ÿ A æ˜¯å¦æ”¶åˆ°ç´…è‰²è­¦å‘Šé€šçŸ¥

**é æœŸçµæœ**:
- å¸³è™Ÿ A çœ‹åˆ°ã€Œä½ å·²è¢«è¶…åƒ¹ï¼ã€é€šçŸ¥
- é¡¯ç¤ºå¸³è™Ÿ B åç¨±å’Œæ–°åƒ¹æ ¼
- é»æ“Šã€Œç«‹å³åŠ åƒ¹ã€æ»¾å‹•åˆ°å‡ºåƒ¹è¼¸å…¥æ¡†
- 10 ç§’å¾Œè‡ªå‹•éš±è—

---

### 4. å€’æ•¸è¨ˆæ™‚å™¨æ¸¬è©¦

**æ­¥é©Ÿ**:
1. å‰µå»ºå³å°‡çµæŸçš„ç«¶æ¨™ï¼ˆ< 2 åˆ†é˜ï¼‰
2. è§€å¯Ÿæœ€å¾Œ 60 ç§’çš„è¦–è¦ºè®ŠåŒ–
3. åœ¨æœ€å¾Œ 60 ç§’å…§å‡ºåƒ¹ï¼Œè§€å¯Ÿå»¶é•·æç¤º

**é æœŸçµæœ**:
- æœ€å¾Œ 60 ç§’æ–‡å­—è®Šç´…è‰² + é–ƒçˆ
- é¡¯ç¤ºã€Œâš¡ å³å°‡çµæŸï¼ã€
- å‡ºåƒ¹å¾Œé¡¯ç¤ºå»¶é•·æç¤º 5 ç§’

---

### 5. æ¬Šé™æ¸¬è©¦

**æ­¥é©Ÿ**:
1. ä½¿ç”¨å‰›è¨»å†Šçš„æ–°å¸³è™Ÿï¼ˆé member/adminï¼‰
2. å˜—è©¦å°ç«¶æ¨™å‡ºåƒ¹

**é æœŸçµæœ**:
- æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶éƒ½èƒ½æˆåŠŸå‡ºåƒ¹
- æœªç™»å…¥ç”¨æˆ¶é¡¯ç¤ºã€Œè«‹å…ˆç™»å…¥ã€

---

## ç›¸é—œæŠ€è¡“

- **å‰ç«¯æ¡†æ¶**: Next.js 14 (App Router)
- **èªè¨€**: TypeScript
- **è³‡æ–™åº«**: Supabase (PostgreSQL)
- **å³æ™‚é€šè¨Š**: Supabase Realtime
- **UI**: Tailwind CSS
- **ç‹€æ…‹ç®¡ç†**: React Hooks

---

## ç‰ˆæœ¬è³‡è¨Š

- **Commit Hash**: `13227ab4cb96c92f4a5154fdc77791ab684d668a`
- **Parent Commit**: `be38af0` (ç®¡ç†å“¡å¾Œå°æ–°å¢å‡ºåƒ¹æŸ¥è©¢é é¢)
- **ä½œè€…**: DingChao Liao
- **æ—¥æœŸ**: 2026-02-17 21:14:59 +0800

---

## ç›¸é—œæ–‡æª”

- [é…å¸ƒé»æ•¸è¨ˆç®—ç³»çµ±.md](file:///Users/alan_dingchaoliao/Documents/ç¶²ç«™é–‹ç™¼/ç¶²ç«™æ¶è¨­/docs/é…å¸ƒé»æ•¸è¨ˆç®—ç³»çµ±.md)
- [Supabase Realtime å®˜æ–¹æ–‡æª”](https://supabase.com/docs/guides/realtime)

---

**æ–‡æª”å»ºç«‹æ™‚é–“**: 2026-02-17 22:28:15 +0800  
**æœ€å¾Œæ›´æ–°**: 2026-02-17 22:28:15 +0800
